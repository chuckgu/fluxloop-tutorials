<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verify that the agent provides clear, persona-aware responses
while meeting latency and accuracy targets.
</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <main class="max-w-6xl mx-auto p-8 space-y-6">
    <header class="space-y-6">
      <div>
      <h1 class="text-3xl font-bold">Verify that the agent provides clear, persona-aware responses
while meeting latency and accuracy targets.
</h1>
      <p class="text-sm text-slate-300">Generated at 2025-11-15T14:44:32Z</p>
      </div>
      <nav class="flex flex-wrap gap-2" role="tablist" aria-label="Report sections">
        <button class="tab-button px-4 py-2 rounded-full bg-sky-500/20 border border-sky-400 text-sky-200 font-semibold" data-tab-button="summary">Executive Summary</button>
        <button class="tab-button px-4 py-2 rounded-full bg-slate-800 border border-slate-700" data-tab-button="personas">Persona Insights</button>
        <button class="tab-button px-4 py-2 rounded-full bg-slate-800 border border-slate-700" data-tab-button="analysis">Deep Analysis</button>
        <button class="tab-button px-4 py-2 rounded-full bg-slate-800 border border-slate-700" data-tab-button="traces">Trace Explorer</button>
      </nav>
    </header>

    <section data-tab-panel="summary" class="tab-panel space-y-6">
      <div id="summaryCards" class="grid gap-4 md:grid-cols-2 xl:grid-cols-4"></div>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold">Success Criteria</h2>
        <div id="criteriaList" class="space-y-3"></div>
      </section>

      <section class="space-y-3">
        <div class="flex items-center gap-2">
          <h2 class="text-xl font-semibold">Recommendations</h2>
          <span class="text-xs uppercase tracking-wide text-slate-400">Auto-generated</span>
        </div>
        <div id="recommendations" class="grid gap-4 md:grid-cols-2"></div>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold">Score Trend</h2>
        <canvas id="scoreChart" height="200"></canvas>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold">Top Failure Reasons</h2>
        <div id="topReasons" class="grid gap-3 md:grid-cols-2"></div>
      </section>
    </section>

    <section data-tab-panel="personas" class="tab-panel hidden space-y-4">
      <p class="text-sm text-slate-300">Compare persona-level performance to target thresholds.</p>
      <div id="personaSummary" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"></div>
    </section>

    <section data-tab-panel="analysis" class="tab-panel hidden space-y-4">
      <div id="analysisContent" class="space-y-4"></div>
    </section>

    <section data-tab-panel="traces" class="tab-panel hidden space-y-4">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <label for="tracePersonaFilter" class="block text-sm text-slate-300 font-medium mb-1">Persona filter</label>
          <select id="tracePersonaFilter" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400">
            <option value="all">All personas</option>
          </select>
        </div>
        <p id="traceCountHint" class="text-xs text-slate-400"></p>
      </div>
      <div class="overflow-x-auto border border-slate-800 rounded-lg">
        <table class="min-w-full divide-y divide-slate-800" id="traceTable">
          <thead class="bg-slate-900/60 text-xs uppercase tracking-wide text-slate-400">
            <tr>
              <th class="px-4 py-3 text-left">Trace ID</th>
              <th class="px-4 py-3 text-left">Persona</th>
              <th class="px-4 py-3 text-left">Iteration</th>
              <th class="px-4 py-3 text-left">Final Score</th>
              <th class="px-4 py-3 text-left">Pass</th>
              <th class="px-4 py-3 text-left">Reasons</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800 text-sm text-slate-200"></tbody>
        </table>
      </div>
      <details class="bg-slate-900 rounded-lg p-4 border border-slate-800">
        <summary class="cursor-pointer font-semibold">Raw per-trace payload</summary>
        <pre class="mt-4 text-xs whitespace-pre-wrap break-words bg-slate-950 rounded p-3 overflow-x-auto" id="rawTraceJson"></pre>
      </details>
    </section>
  </main>

  <script>
    const summary = {"total_traces": 5, "passed_traces": 3, "pass_rate": 0.6, "average_score": 0.6904808989978224, "threshold": 0.7, "aggregate_method": "weighted_sum", "evaluators": ["not_empty", "latency_budget", "keyword_quality", "similarity_to_expected", "intent_recognition", "response_consistency", "response_clarity"], "evaluator_stats": {"not_empty": {"average": 1.0, "min": 1.0, "max": 1.0, "count": 5}, "latency_budget": {"average": 0.038125843485845336, "min": 0.02105527909336589, "max": 0.07521541000043541, "count": 5}, "keyword_quality": {"average": 0.9, "min": 0.75, "max": 1.0, "count": 5}, "similarity_to_expected": {"average": 0.0, "min": 0.0, "max": 0.0, "count": 5}, "intent_recognition": {"average": 0.88, "min": 0.6, "max": 1.0, "count": 5}, "response_consistency": {"average": 0.8, "min": 0.4, "max": 1.0, "count": 5}, "response_clarity": {"average": 0.9, "min": 0.9, "max": 0.9, "count": 5}}, "persona_breakdown": {"novice_user": {"count": 3, "average_score": 0.6677228092165006, "pass_rate": 0.6666666666666666}, "expert_user": {"count": 2, "average_score": 0.7246180336698049, "pass_rate": 0.5}}, "top_reasons": [["expected value not provided", 5], ["missing keywords: help", 2], ["duration 55402.5ms exceeds budget 1500.0ms", 1], ["The agent correctly resolved the immediate intent by providing the current flight time/status and booking details, gave clear, novice-friendly, step-by-step methods to check flight info (website, app, email, airport), offered urgent next steps given the imminent departure, and invited follow-up to fetch gate/boarding status.", 1], ["The reply is clear, coherent, and directly answers the question with practical steps and exact flight details, but it omits explaining how the assistant accessed the booking (authentication/privacy), a minor gap.", 1], ["Clear, well-structured and actionable with urgent next steps (website, app, check-in timing) — the main missing detail is the current gate/boarding status (assistant offers to check but doesn't provide it).", 1], ["duration 71241.0ms exceeds budget 1500.0ms", 1], ["The agent correctly addressed both parts of the request by giving a departure time and clear, practical ways to check a flight without a booking number, but it improperly fabricated specific flight details (LX0112 and dates) and assumed the airline, which is a significant hallucination.", 1], ["The reply gives useful checking steps but improperly asserts specific flight details (\"Your flight (LX0112) from Paris Charles de Gaulle (CDG) to Basel (BSL) is scheduled to depart on 15 Nov 2025 at 23:39\") without any booking/reference from the user, which is a likely hallucination and inconsistent with guidance to avoid unfounded claims.", 1], ["Clear, well-organized, and actionable — particularly the \"Use your e‑ticket/ticket number + last name\" bullet which gives a concrete retrieval method, though it could be improved by adding the Swiss website link or a reservations phone number.", 1]], "evaluation_goal": "Verify that the agent provides clear, persona-aware responses\nwhile meeting latency and accuracy targets.\n", "success_criteria_results": {"performance": {"all_traces_successful": {"met": true, "expected": true, "total_traces": 5, "successful_traces": 5}, "avg_response_time": {"met": false, "average_ms": 49365.00234603882, "threshold_ms": 2000, "trace_count": 5}}, "quality": {"intent_recognition": {"met": true, "average_score": 0.88, "threshold": 0.7, "pass_rate": 0.8, "trace_count": 5}, "response_consistency": {"met": true, "average_score": 0.8, "threshold": 0.7, "pass_rate": 0.8, "trace_count": 5}, "response_clarity": {"met": true, "average_score": 0.9, "threshold": 0.7, "pass_rate": 1.0, "trace_count": 5}}, "functionality": {}, "overall_success": false}, "overall_success": false, "analysis": {"recommendations": [{"title": "Boost overall pass rate", "priority": "high", "summary": "Pass rate is 60.0% (goal 70.0%). Most common failure reason: expected value not provided.", "metrics": {"pass_rate": 0.6, "threshold": 0.7}}, {"title": "Target persona 'novice_user'", "priority": "medium", "summary": "novice_user pass rate is 66.7% (goal 70.0%). Prioritize playbooks or prompts for this persona.", "metrics": {"persona": "novice_user", "pass_rate": 0.6666666666666666, "threshold": 0.7}}, {"title": "Target persona 'expert_user'", "priority": "medium", "summary": "expert_user pass rate is 50.0% (goal 70.0%). Prioritize playbooks or prompts for this persona.", "metrics": {"persona": "expert_user", "pass_rate": 0.5, "threshold": 0.7}}]}, "report": {"format": "both", "style": "standard", "tone": "balanced", "template": "default"}, "llm_calls": 15, "llm_sample_rate": 1.0};
    const perTrace = [{"trace_id": "0b4f97e1-f8a9-4b79-9570-6d10b46b579f", "iteration": 0, "persona": "novice_user", "success": true, "duration_ms": 55402.45199203491, "scores": {"not_empty": 1.0, "latency_budget": 0.027074613957801936, "keyword_quality": 0.75, "similarity_to_expected": 0.0, "intent_recognition": 1.0, "response_consistency": 0.9, "response_clarity": 0.9}, "final_score": 0.7195499406088927, "pass": true, "reasons": {"latency_budget": ["duration 55402.5ms exceeds budget 1500.0ms"], "keyword_quality": ["missing keywords: help"], "similarity_to_expected": ["expected value not provided"], "intent_recognition": ["The agent correctly resolved the immediate intent by providing the current flight time/status and booking details, gave clear, novice-friendly, step-by-step methods to check flight info (website, app, email, airport), offered urgent next steps given the imminent departure, and invited follow-up to fetch gate/boarding status."], "response_consistency": ["The reply is clear, coherent, and directly answers the question with practical steps and exact flight details, but it omits explaining how the assistant accessed the booking (authentication/privacy), a minor gap."], "response_clarity": ["Clear, well-structured and actionable with urgent next steps (website, app, check-in timing) — the main missing detail is the current gate/boarding status (assistant offers to check but doesn't provide it)."]}}, {"trace_id": "6dd78a8d-ad8d-49cd-82e9-78677afe4f5f", "iteration": 0, "persona": "novice_user", "success": true, "duration_ms": 71241.0409450531, "scores": {"not_empty": 1.0, "latency_budget": 0.02105527909336589, "keyword_quality": 1.0, "similarity_to_expected": 0.0, "intent_recognition": 0.6, "response_consistency": 0.4, "response_clarity": 0.9}, "final_score": 0.5647777352451332, "pass": false, "reasons": {"latency_budget": ["duration 71241.0ms exceeds budget 1500.0ms"], "similarity_to_expected": ["expected value not provided"], "intent_recognition": ["The agent correctly addressed both parts of the request by giving a departure time and clear, practical ways to check a flight without a booking number, but it improperly fabricated specific flight details (LX0112 and dates) and assumed the airline, which is a significant hallucination."], "response_consistency": ["The reply gives useful checking steps but improperly asserts specific flight details (\"Your flight (LX0112) from Paris Charles de Gaulle (CDG) to Basel (BSL) is scheduled to depart on 15 Nov 2025 at 23:39\") without any booking/reference from the user, which is a likely hallucination and inconsistent with guidance to avoid unfounded claims."], "response_clarity": ["Clear, well-organized, and actionable — particularly the \"Use your e‑ticket/ticket number + last name\" bullet which gives a concrete retrieval method, though it could be improved by adding the Swiss website link or a reservations phone number."]}}, {"trace_id": "9b9a2425-9e53-42cd-bef9-c81ddccada4f", "iteration": 0, "persona": "novice_user", "success": true, "duration_ms": 66770.86877822876, "scores": {"not_empty": 1.0, "latency_budget": 0.022464886670593816, "keyword_quality": 1.0, "similarity_to_expected": 0.0, "intent_recognition": 0.9, "response_consistency": 0.9, "response_clarity": 0.9}, "final_score": 0.718840751795476, "pass": true, "reasons": {"latency_budget": ["duration 66770.9ms exceeds budget 1500.0ms"], "similarity_to_expected": ["expected value not provided"], "intent_recognition": ["Directly provided the departure time and clear, novice‑friendly, urgent next steps plus ways to check status and a follow‑up offer, but slightly assumed access to the booking without explicitly confirming the user's identity."], "response_consistency": ["Overall clear, coherent and helpful — but slightly oversteps by stating \"I can see your booking\" without clarifying how it has access to the user's booking (privacy/authorization assumption)."], "response_clarity": ["Clear, empathetic and actionable — the urgent line \"the flight is due to depart very soon (about 3 minutes from now). If you are not already at the airport and checked in, please get to the airport immediately...\" drives the score; slightly docked for not including a direct SWISS contact number or immediate gate info."]}}, {"trace_id": "4623411f-7cea-4e4a-9d44-86b6ef26ef1c", "iteration": 0, "persona": "expert_user", "success": true, "duration_ms": 19942.721843719482, "scores": {"not_empty": 1.0, "latency_budget": 0.07521541000043541, "keyword_quality": 1.0, "similarity_to_expected": 0.0, "intent_recognition": 1.0, "response_consistency": 1.0, "response_clarity": 0.9}, "final_score": 0.7654177553846824, "pass": true, "reasons": {"latency_budget": ["duration 19942.7ms exceeds budget 1500.0ms"], "similarity_to_expected": ["expected value not provided"], "intent_recognition": ["The agent correctly identified the flight, accurately converted the recorded timestamp into the departure-airport local time (Europe/Paris) and UTC, clearly labelled the original timezone, and offered appropriate follow-up options."], "response_consistency": ["The assistant consistently extracted the recorded timestamp and correctly converted it to UTC and Paris local time (CET/UTC+1) with no contradictions or unnecessary information."], "response_clarity": ["Clear, well-formatted time conversions and a useful follow-up offer, but the line \"Scheduled departure (recorded): 2025-11-15 23:43:27.627624 -04:00\" most drives my score because it lacks an explanation of why the record uses -04:00 and could confuse users about the source timezone."]}}, {"trace_id": "a1c969ef-4d1e-420b-8a8c-41333233f44b", "iteration": 0, "persona": "expert_user", "success": true, "duration_ms": 33467.92817115784, "scores": {"not_empty": 1.0, "latency_budget": 0.04481902770702961, "keyword_quality": 0.75, "similarity_to_expected": 0.0, "intent_recognition": 0.9, "response_consistency": 0.8, "response_clarity": 0.9}, "final_score": 0.6838183119549276, "pass": false, "reasons": {"latency_budget": ["duration 33467.9ms exceeds budget 1500.0ms"], "keyword_quality": ["missing keywords: help"], "similarity_to_expected": ["expected value not provided"], "intent_recognition": ["The agent correctly handled the request by reporting the PNR lookup failure, returning the scheduled departure in ISO 8601 for local time and UTC, and providing a concrete \"fastest\" API endpoint + headers and curl example, with only a minor deduction for not directly resolving PNR X1Z2Y3 before asking for confirmation."], "response_consistency": ["Response is largely consistent—it correctly reports PNR X1Z2Y3 not found, provides ISO-8601 local/UTC times for the available PNR and a clear API call—but it claims \"I checked your bookings database\" (asserting access) without showing how the Authorization token would be obtained and omits that prerequisite, which is a minor alignment/clarity issue."], "response_clarity": ["Clear and actionable — the sentence \"I checked your bookings database and could not find a reservation under PNR X1Z2Y3.\" clarifies status and the \"Required headers (minimum):\" bullet provides exact API call details; I docked a point because the API base URL may be assumed/example and not explicitly noted as potentially fictional."]}}];
    const criteria = {"performance": {"all_traces_successful": {"met": true, "expected": true, "total_traces": 5, "successful_traces": 5}, "avg_response_time": {"met": false, "average_ms": 49365.00234603882, "threshold_ms": 2000, "trace_count": 5}}, "quality": {"intent_recognition": {"met": true, "average_score": 0.88, "threshold": 0.7, "pass_rate": 0.8, "trace_count": 5}, "response_consistency": {"met": true, "average_score": 0.8, "threshold": 0.7, "pass_rate": 0.8, "trace_count": 5}, "response_clarity": {"met": true, "average_score": 0.9, "threshold": 0.7, "pass_rate": 1.0, "trace_count": 5}}, "functionality": {}, "overall_success": false};
    const analysis = {"recommendations": [{"title": "Boost overall pass rate", "priority": "high", "summary": "Pass rate is 60.0% (goal 70.0%). Most common failure reason: expected value not provided.", "metrics": {"pass_rate": 0.6, "threshold": 0.7}}, {"title": "Target persona 'novice_user'", "priority": "medium", "summary": "novice_user pass rate is 66.7% (goal 70.0%). Prioritize playbooks or prompts for this persona.", "metrics": {"persona": "novice_user", "pass_rate": 0.6666666666666666, "threshold": 0.7}}, {"title": "Target persona 'expert_user'", "priority": "medium", "summary": "expert_user pass rate is 50.0% (goal 70.0%). Prioritize playbooks or prompts for this persona.", "metrics": {"persona": "expert_user", "pass_rate": 0.5, "threshold": 0.7}}]};

    const state = {
      activeTab: "summary",
      personaFilter: "all",
    };

    function setActiveTab(tab) {
      state.activeTab = tab;
      document.querySelectorAll("[data-tab-panel]").forEach((panel) => {
        panel.classList.toggle("hidden", panel.dataset.tabPanel !== tab);
      });
      document.querySelectorAll("[data-tab-button]").forEach((button) => {
        const isActive = button.dataset.tabButton === tab;
        button.classList.toggle("bg-sky-500/20", isActive);
        button.classList.toggle("text-sky-200", isActive);
        button.classList.toggle("border-sky-400", isActive);
        button.classList.toggle("bg-slate-800", !isActive);
        button.classList.toggle("text-slate-300", !isActive);
        button.classList.toggle("border-slate-700", !isActive);
        button.setAttribute("aria-selected", String(isActive));
      });
    }

    function initTabs() {
      document.querySelectorAll("[data-tab-button]").forEach((button) => {
        button.addEventListener("click", () => {
          setActiveTab(button.dataset.tabButton);
        });
      });
      setActiveTab(state.activeTab);
    }

    function formatPercent(value) {
      if (value == null) return "—";
      return `${(value * 100).toFixed(1)}%`;
    }

    function toTitleCase(value) {
      return (value || "")
        .replace(/_/g, " ")
        .replace(/\b\w/g, (c) => c.toUpperCase());
    }

    function renderSummaryCards() {
      const container = document.getElementById("summaryCards");
      if (!container || !summary) return;
      const cards = [
        { label: "Total Traces", value: summary.total_traces ?? "—" },
        { label: "Pass Rate", value: formatPercent(summary.pass_rate) },
        {
          label: "Average Score",
          value: summary.average_score != null ? summary.average_score.toFixed(3) : "—",
        },
        {
          label: "Threshold",
          value: summary.threshold != null ? summary.threshold.toFixed(2) : "—",
        },
      ];
      if (summary.llm_calls != null) {
        cards.push({
          label: "LLM Calls",
          value: `${summary.llm_calls} (sample ${(summary.llm_sample_rate ?? 0).toFixed(2)})`,
        });
      }
      if (summary.overall_success !== undefined) {
        cards.push({
          label: "Overall Success",
          value: summary.overall_success ? "✅ Met" : "❌ Not Met",
        });
      }
      container.innerHTML = cards
            .map(
          (card) => `
            <div class="bg-slate-900 rounded-xl p-4 border border-slate-800 shadow-inner">
              <p class="text-slate-400 text-xs uppercase tracking-wide">${card.label}</p>
              <p class="text-2xl font-semibold mt-2">${card.value}</p>
                </div>
              `
            )
        .join("");
    }

    function renderCriteria() {
      const container = document.getElementById("criteriaList");
      if (!container || !criteria || !Object.keys(criteria).length) {
        if (container) container.innerHTML = "<p class='text-sm text-slate-400'>No criteria configured.</p>";
        return;
      }
      const overall = criteria.overall_success;
      container.innerHTML = `
        ${
          overall !== undefined
            ? `<p class="text-sm text-slate-300">Overall success: ${
                overall ? "✅ Met" : "❌ Not met"
              }</p>`
            : ""
        }
      `;
      Object.entries(criteria)
        .filter(([key]) => key !== "overall_success")
        .forEach(([section, payload]) => {
          if (!payload) return;
          const checks = Object.entries(payload);
          if (!checks.length) return;
        const sectionTitle = section.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
          const wrapper = document.createElement("div");
          wrapper.className = "bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-2";
          wrapper.innerHTML = `<h3 class="text-lg font-semibold">${sectionTitle}</h3>`;
        const list = document.createElement("ul");
        list.className = "space-y-1 text-sm text-slate-300";
        for (const [name, details] of checks) {
            const prettyName = toTitleCase(name);
          const status = details.met === true ? "✅ Met" : details.met === false ? "❌ Not met" : "⚪️ Not evaluated";
            const meta = { ...details };
            delete meta.met;
            const extra =
              Object.keys(meta).length > 0 ? `<span class="text-slate-400"> ${JSON.stringify(meta)}</span>` : "";
            list.innerHTML += `<li>${status} · ${prettyName}${extra}</li>`;
        }
          wrapper.appendChild(list);
          container.appendChild(wrapper);
        });
    }

    function renderRecommendations() {
      const container = document.getElementById("recommendations");
      if (!container) return;
      const recommendations = (analysis && analysis.recommendations) || [];
      if (!recommendations.length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>No blocking action items detected.</p>";
        return;
      }
      container.innerHTML = recommendations
        .map(
          (item) => `
            <article class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-2 shadow-inner">
              <div class="flex items-center justify-between gap-2">
                <h3 class="text-lg font-semibold">${item.title}</h3>
                <span class="text-xs px-2 py-1 rounded-full border ${
                  item.priority === "high"
                    ? "border-rose-400 text-rose-300"
                    : item.priority === "medium"
                    ? "border-amber-400 text-amber-300"
                    : "border-slate-500 text-slate-300"
                }">${item.priority?.toUpperCase() || "MEDIUM"}</span>
              </div>
              <p class="text-sm text-slate-300 leading-relaxed">${item.summary || ""}</p>
            </article>
          `
        )
        .join("");
    }

    function renderTopReasons() {
      const container = document.getElementById("topReasons");
      if (!container) return;
      const reasons = summary.top_reasons || [];
      if (!Array.isArray(reasons) || !reasons.length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>No failure reasons recorded.</p>";
        return;
      }
      container.innerHTML = reasons
        .map(
          ([reason, count]) => `
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
              <p class="text-sm text-slate-300">${reason}</p>
              <p class="mt-2 text-2xl font-semibold">${count}</p>
            </div>
          `
        )
        .join("");
    }

    function renderPersonaSummary() {
      const container = document.getElementById("personaSummary");
      if (!container) return;
      const breakdown = summary.persona_breakdown || {};
      const entries = Object.entries(breakdown);
      if (!entries.length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>Persona breakdown is not available.</p>";
        return;
      }
      container.innerHTML = entries
        .map(
          ([persona, stats]) => `
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-1">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">${persona}</h3>
                <span class="text-xs text-slate-400">n=${stats.count ?? 0}</span>
              </div>
              <p class="text-sm text-slate-300">Pass rate: ${formatPercent(stats.pass_rate)}</p>
              <p class="text-sm text-slate-300">Average score: ${
                stats.average_score != null ? stats.average_score.toFixed(3) : "—"
              }</p>
            </div>
          `
        )
        .join("");
    }

    function renderAnalysisContent() {
      const container = document.getElementById("analysisContent");
      if (!container) return;
      if (!analysis || !Object.keys(analysis).length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>No additional analysis computed.</p>";
        return;
      }
      const entries = Object.entries(analysis).filter(([key]) => key !== "recommendations");
      if (!entries.length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>No additional analysis computed.</p>";
        return;
      }
      container.innerHTML = entries
        .map(
          ([key, value]) => `
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
              <h3 class="text-lg font-semibold mb-2">${toTitleCase(key)}</h3>
              <pre class="text-xs whitespace-pre-wrap break-words">${JSON.stringify(value, null, 2)}</pre>
            </div>
          `
        )
        .join("");
    }

    function renderScoreChart() {
      if (typeof Chart === "undefined" || !Array.isArray(perTrace) || !perTrace.length) return;
      const ctx = document.getElementById("scoreChart");
      if (!ctx) return;
      const labels = perTrace.map((item) => item.trace_id ?? item.iteration ?? "");
      const data = perTrace.map((item) => item.final_score ?? 0);
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Final Score",
              data,
              tension: 0.3,
              fill: false,
              borderColor: "#38bdf8",
              backgroundColor: "#38bdf8",
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: { suggestedMin: 0, suggestedMax: 1 },
          },
        },
      });
    }

    function initTraceFilter() {
      const select = document.getElementById("tracePersonaFilter");
      if (!select) return;
      const personas = Array.from(
        new Set(
          perTrace
            .map((item) => item.persona || "default")
            .filter(Boolean)
        )
      ).sort();
      select.innerHTML = `<option value="all">All personas</option>` + personas.map((p) => `<option value="${p}">${p}</option>`).join("");
      select.value = state.personaFilter;
      select.addEventListener("change", (event) => {
        state.personaFilter = event.target.value;
        renderTraceTable();
      });
      renderTraceTable();
    }

    function renderTraceTable() {
      const table = document.getElementById("traceTable");
      const rawJson = document.getElementById("rawTraceJson");
      if (!table) return;
      const tbody = table.querySelector("tbody");
      const filtered = perTrace.filter((item) => {
        if (state.personaFilter === "all") return true;
        const persona = item.persona || "default";
        return persona === state.personaFilter;
      });
      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-sm text-slate-400">No traces match the selected filters.</td></tr>`;
      } else {
        tbody.innerHTML = filtered
          .map(
            (item) => `
              <tr class="hover:bg-slate-900/60">
                <td class="px-4 py-3">${item.trace_id ?? "—"}</td>
                <td class="px-4 py-3">${item.persona ?? "—"}</td>
                <td class="px-4 py-3">${item.iteration ?? "—"}</td>
                <td class="px-4 py-3">${item.final_score != null ? item.final_score.toFixed(3) : "—"}</td>
                <td class="px-4 py-3">${item.pass ? "✅" : "❌"}</td>
                <td class="px-4 py-3">
                  ${
                    item.reasons
                      ? Object.entries(item.reasons)
                          .map(([key, value]) => `<span class="block text-xs text-slate-300">${key}: ${Array.isArray(value) ? value.join(", ") : value}</span>`)
                          .join("")
                      : "<span class='text-xs text-slate-500'>—</span>"
                  }
                </td>
              </tr>
            `
          )
          .join("");
      }
      if (rawJson) {
        rawJson.textContent = JSON.stringify(filtered, null, 2);
      }
      const hint = document.getElementById("traceCountHint");
      if (hint) {
        const total = perTrace.length;
        const shown = filtered.length;
        const suffix = total === 1 ? "" : "s";
        hint.textContent = `${shown} of ${total} trace${suffix} shown`;
    }
    }

    initTabs();
    renderSummaryCards();
    renderCriteria();
    renderRecommendations();
    renderScoreChart();
    renderTopReasons();
    renderPersonaSummary();
    renderAnalysisContent();
    initTraceFilter();
  </script>
</body>
</html>
