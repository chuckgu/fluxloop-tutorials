<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="report:generated_at" content="2025-11-17T05:06:09Z" />
  <title>FluxLoop Evaluation Report</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <main class="max-w-6xl mx-auto p-8 space-y-6">
    <header class="space-y-6">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-3xl font-bold">FluxLoop Evaluation Report</h1>
          <p class="text-sm text-slate-300">Generated on 2025-11-17 05:06:09Z · Experiment: tutorial_experiment_20251116_163238</p>
        </div>
        <a
          href="https://fluxloop.io/"
          class="inline-flex items-center gap-2 self-start rounded-full border border-sky-400 px-4 py-2 text-sm font-semibold text-sky-200 transition hover:bg-sky-500/10 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-offset-2 focus:ring-offset-slate-950"
          target="_blank"
          rel="noopener noreferrer"
        >
          <span>Built with FluxLoop</span>
        </a>
      </div>
      <nav class="flex flex-wrap gap-2" role="tablist" aria-label="Report sections">
        <button class="tab-button px-4 py-2 rounded-full bg-sky-500/20 border border-sky-400 text-sky-200 font-semibold" data-tab-button="summary">Executive Summary</button>
        <button class="tab-button px-4 py-2 rounded-full bg-slate-800 border border-slate-700" data-tab-button="personas">Persona Insights</button>
        <button class="tab-button px-4 py-2 rounded-full bg-slate-800 border border-slate-700" data-tab-button="analysis">Deep Analysis</button>
        <button class="tab-button px-4 py-2 rounded-full bg-slate-800 border border-slate-700" data-tab-button="traces">Trace Explorer</button>
      </nav>
    </header>

    <section data-tab-panel="summary" class="tab-panel space-y-6">
      <div id="summaryCards" class="grid gap-4 md:grid-cols-2 xl:grid-cols-4"></div>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold">Evaluation Goal</h2>
        <div id="evaluationGoal" class="whitespace-pre-wrap rounded-xl border border-slate-800 bg-slate-900 p-4 text-sm text-slate-300"></div>
      </section>

      <section class="space-y-4">
        <h2 class="text-xl font-semibold">Success Criteria</h2>
        <div id="criteriaList" class="space-y-3"></div>
      </section>

      <section class="space-y-3">
        <div class="flex items-center gap-2">
          <h2 class="text-xl font-semibold">Recommendations</h2>
          <span class="text-xs uppercase tracking-wide text-slate-400">Auto-generated</span>
        </div>
        <div id="recommendations" class="grid gap-4 md:grid-cols-2"></div>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold">Score Trend</h2>
        <canvas id="scoreChart" height="200"></canvas>
      </section>

      <section class="space-y-3">
        <h2 class="text-xl font-semibold">Top Failure Reasons</h2>
        <div id="topReasons" class="grid gap-3 md:grid-cols-2"></div>
      </section>
    </section>

    <section data-tab-panel="personas" class="tab-panel hidden space-y-4">
      <p class="text-sm text-slate-300">Compare persona-level performance to target thresholds.</p>
      <div id="personaSummary" class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"></div>
    </section>

    <section data-tab-panel="analysis" class="tab-panel hidden space-y-4">
      <div id="analysisContent" class="space-y-4"></div>
    </section>

    <section data-tab-panel="traces" class="tab-panel hidden space-y-4">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <label for="tracePersonaFilter" class="block text-sm text-slate-300 font-medium mb-1">Persona filter</label>
          <select id="tracePersonaFilter" class="bg-slate-900 border border-slate-700 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-400">
            <option value="all">All personas</option>
          </select>
        </div>
        <p id="traceCountHint" class="text-xs text-slate-400"></p>
      </div>
      <div class="overflow-x-auto border border-slate-800 rounded-lg">
        <table class="min-w-full divide-y divide-slate-800" id="traceTable">
          <thead class="bg-slate-900/60 text-xs uppercase tracking-wide text-slate-400">
            <tr>
              <th class="px-4 py-3 text-left">Trace ID</th>
              <th class="px-4 py-3 text-left">Persona</th>
              <th class="px-4 py-3 text-left">Iteration</th>
              <th class="px-4 py-3 text-left">Final Score</th>
              <th class="px-4 py-3 text-left">Pass</th>
              <th class="px-4 py-3 text-left">Reasons</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800 text-sm text-slate-200"></tbody>
        </table>
      </div>
      <details class="bg-slate-900 rounded-lg p-4 border border-slate-800">
        <summary class="cursor-pointer font-semibold">Raw per-trace payload</summary>
        <pre class="mt-4 text-xs whitespace-pre-wrap break-words bg-slate-950 rounded p-3 overflow-x-auto" id="rawTraceJson"></pre>
      </details>
    </section>
  </main>

  <script>
    const summary = {"total_traces": 6, "passed_traces": 0, "pass_rate": 0.0, "average_score": 0.5540985292249941, "threshold": 0.7, "aggregate_method": "weighted_sum", "evaluators": ["not_empty", "token_budget", "keyword_quality", "intent_recognition", "response_consistency", "response_clarity"], "evaluator_stats": {"not_empty": {"average": 1.0, "min": 1.0, "max": 1.0, "count": 6}, "token_budget": {"average": 0.9787578420166307, "min": 0.8725470520997844, "max": 1.0, "count": 6}, "keyword_quality": {"average": 0.75, "min": 0.75, "max": 0.75, "count": 6}, "intent_recognition": {"average": 0.16666666666666669, "min": 0.1, "max": 0.2, "count": 6}, "response_consistency": {"average": 0.25, "min": 0.2, "max": 0.4, "count": 6}, "response_clarity": {"average": 0.45, "min": 0.2, "max": 0.8, "count": 6}}, "persona_breakdown": {"novice_user": {"count": 3, "average_score": 0.5513888888888889, "pass_rate": 0.0}, "expert_user": {"count": 3, "average_score": 0.5568081695610992, "pass_rate": 0.0}}, "top_reasons": [["missing keywords: help", 6], ["The agent failed to address the user's question about their flight time or how to check it, instead asking unrelated booking clarifications and assuming a \"second day\" date without providing any flight-checking steps or retrieving flight info.", 1], ["The assistant's reply is inconsistent with the user's question about flight time—it launches an unrelated booking flow, fails to explain how to check a flight, and even assumes an arrival date of 2025-11-17 without justification.", 1], ["The reply is clear about booking follow-ups but fails to answer the user's flight-time question—the opening line \"OK great pick one and book it for my second day there.\" (and the assumption \"I’ll use your arrival info... 2025-11-17\") is off-topic and the assistant omits any concrete steps for checking flight time.", 1], ["The agent completely missed the user's request—its reply is about booking a tour (\"I’ll pick a popular option and book it\") rather than providing the flight departure time or actionable ways to check it without a booking/reference number (e.g., search by name/email, airline website/app, call the airline or airport).", 1], ["The reply is irrelevant and inconsistent with the user's question — it focuses on booking a tour and even asserts a flight arrival date (\"that would be 2025-11-17, since your flight arrives 2025-11-16\") instead of telling the user how to find their flight departure time without a booking/reference number.", 1], ["The assistant's numbered confirmation questions are clear, organized, and actionable, but it omits key booking details—how payment, confirmation, and cancellation will be handled (missing detail).", 1], ["The agent completely misses the user's intent—asking how to find their flight departure time—and instead provides unrelated tour-booking clarifications (e.g., \"second day there\", party size, time preferences) without answering the flight-time question or giving steps (check itinerary, airline app, confirmation email, airport departures).", 1], ["The assistant ignored the user's question about finding flight departure times and instead proceeded with unrelated booking clarifications, making unwarranted assumptions such as \"By 'second day there' you mean 2025-11-17 (your flight arrives 2025-11-16),\" which is not supported by the conversation.", 1], ["The assistant fails to answer the user's question about finding their flight time and instead asks unrelated booking clarifications—the missing actionable detail (e.g., \"check your confirmation email, airline website/app, or use your booking reference\") and the bullet list of booking questions most drive this low score.", 1]], "evaluation_goal": "Verify that the agent provides clear, persona-aware responses\nwhile meeting latency and accuracy targets.\n", "success_criteria_results": {"performance": {"all_traces_successful": {"met": true, "expected": true, "total_traces": 6, "successful_traces": 6}}, "quality": {"intent_recognition": {"met": false, "average_score": 0.16666666666666669, "threshold": 0.7, "pass_rate": 0.0, "trace_count": 6}, "response_consistency": {"met": false, "average_score": 0.25, "threshold": 0.7, "pass_rate": 0.0, "trace_count": 6}, "response_clarity": {"met": false, "average_score": 0.45, "threshold": 0.7, "pass_rate": 0.3333333333333333, "trace_count": 6}}, "functionality": {}, "overall_success": false}, "overall_success": false, "analysis": {"recommendations": [{"title": "Boost overall pass rate", "priority": "high", "summary": "Pass rate is 0.0% (goal 70.0%). Most common failure reason: missing keywords: help.", "metrics": {"pass_rate": 0.0, "threshold": 0.7}}, {"title": "Target persona 'novice_user'", "priority": "medium", "summary": "novice_user pass rate is 0.0% (goal 70.0%). Prioritize playbooks or prompts for this persona.", "metrics": {"persona": "novice_user", "pass_rate": 0.0, "threshold": 0.7}}, {"title": "Target persona 'expert_user'", "priority": "medium", "summary": "expert_user pass rate is 0.0% (goal 70.0%). Prioritize playbooks or prompts for this persona.", "metrics": {"persona": "expert_user", "pass_rate": 0.0, "threshold": 0.7}}]}, "report": {"format": "both", "style": "standard", "tone": "balanced", "template": "default"}, "llm_calls": 18, "llm_sample_rate": 1.0};
    const perTrace = [{"trace_id": "37cb7580-0f89-40d0-96d4-4338dfc0dc07", "iteration": 0, "persona": "novice_user", "success": true, "duration_ms": 393777.15826034546, "scores": {"not_empty": 1.0, "token_budget": 1.0, "keyword_quality": 0.75, "intent_recognition": 0.2, "response_consistency": 0.2, "response_clarity": 0.3}, "final_score": 0.5291666666666667, "pass": false, "reasons": {"keyword_quality": ["missing keywords: help"], "intent_recognition": ["The agent failed to address the user's question about their flight time or how to check it, instead asking unrelated booking clarifications and assuming a \"second day\" date without providing any flight-checking steps or retrieving flight info."], "response_consistency": ["The assistant's reply is inconsistent with the user's question about flight time—it launches an unrelated booking flow, fails to explain how to check a flight, and even assumes an arrival date of 2025-11-17 without justification."], "response_clarity": ["The reply is clear about booking follow-ups but fails to answer the user's flight-time question—the opening line \"OK great pick one and book it for my second day there.\" (and the assumption \"I’ll use your arrival info... 2025-11-17\") is off-topic and the assistant omits any concrete steps for checking flight time."]}}, {"trace_id": "07f39c11-1eac-423b-96b9-09aa8a8f588a", "iteration": 0, "persona": "novice_user", "success": true, "duration_ms": 313644.50097084045, "scores": {"not_empty": 1.0, "token_budget": 1.0, "keyword_quality": 0.75, "intent_recognition": 0.2, "response_consistency": 0.2, "response_clarity": 0.8}, "final_score": 0.6125000000000002, "pass": false, "reasons": {"keyword_quality": ["missing keywords: help"], "intent_recognition": ["The agent completely missed the user's request—its reply is about booking a tour (\"I’ll pick a popular option and book it\") rather than providing the flight departure time or actionable ways to check it without a booking/reference number (e.g., search by name/email, airline website/app, call the airline or airport)."], "response_consistency": ["The reply is irrelevant and inconsistent with the user's question — it focuses on booking a tour and even asserts a flight arrival date (\"that would be 2025-11-17, since your flight arrives 2025-11-16\") instead of telling the user how to find their flight departure time without a booking/reference number."], "response_clarity": ["The assistant's numbered confirmation questions are clear, organized, and actionable, but it omits key booking details—how payment, confirmation, and cancellation will be handled (missing detail)."]}}, {"trace_id": "8335207f-2417-423d-ae2f-56f8d6015e65", "iteration": 0, "persona": "novice_user", "success": true, "duration_ms": 338131.9229602814, "scores": {"not_empty": 1.0, "token_budget": 1.0, "keyword_quality": 0.75, "intent_recognition": 0.1, "response_consistency": 0.3, "response_clarity": 0.2}, "final_score": 0.5125000000000001, "pass": false, "reasons": {"keyword_quality": ["missing keywords: help"], "intent_recognition": ["The agent completely misses the user's intent—asking how to find their flight departure time—and instead provides unrelated tour-booking clarifications (e.g., \"second day there\", party size, time preferences) without answering the flight-time question or giving steps (check itinerary, airline app, confirmation email, airport departures)."], "response_consistency": ["The assistant ignored the user's question about finding flight departure times and instead proceeded with unrelated booking clarifications, making unwarranted assumptions such as \"By 'second day there' you mean 2025-11-17 (your flight arrives 2025-11-16),\" which is not supported by the conversation."], "response_clarity": ["The assistant fails to answer the user's question about finding their flight time and instead asks unrelated booking clarifications—the missing actionable detail (e.g., \"check your confirmation email, airline website/app, or use your booking reference\") and the bullet list of booking questions most drive this low score."]}}, {"trace_id": "c6fb9607-0122-4a0b-8627-0fc0edd3f078", "iteration": 0, "persona": "expert_user", "success": true, "duration_ms": 384500.35214424133, "scores": {"not_empty": 1.0, "token_budget": 0.8725470520997844, "keyword_quality": 0.75, "intent_recognition": 0.2, "response_consistency": 0.2, "response_clarity": 0.8}, "final_score": 0.5912578420166308, "pass": false, "reasons": {"token_budget": ["total tokens 114607 exceeds budget 100000"], "keyword_quality": ["missing keywords: help"], "intent_recognition": ["The agent ignored the user's flight-info request and instead pursued an unrelated booking task (asking about \"second day there\" and booking preferences), failing to provide scheduled departure times (local/UTC), status, ETD/ETA, terminal/gate or ask any relevant clarifying questions."], "response_consistency": ["The assistant ignored the user's flight-info request and pursued an unrelated booking flow (e.g., \"Do you mean one of the options I suggested earlier...\" ) and even made an incorrect date assumption (\"I assume you mean 2025-11-17 (your flight arrives 2025-11-16)\"), showing a clear mismatch to the user's query."], "response_clarity": ["Clear, organized clarifying questions (notably the three confirmation bullets) provide actionable next steps, but it omits key booking details such as number of travelers and length of stay."]}}, {"trace_id": "ec8723d4-911d-4cf8-87e2-e0f12b924ab8", "iteration": 0, "persona": "expert_user", "success": true, "duration_ms": 272011.3878250122, "scores": {"not_empty": 1.0, "token_budget": 1.0, "keyword_quality": 0.75, "intent_recognition": 0.2, "response_consistency": 0.4, "response_clarity": 0.4}, "final_score": 0.5875000000000001, "pass": false, "reasons": {"keyword_quality": ["missing keywords: help"], "intent_recognition": ["The agent misunderstood the user's request—it asked booking clarifications and referenced an arrival time instead of pulling the scheduled departure from the itinerary and converting/displaying it in local time and UTC, so the core task was ignored."], "response_consistency": ["The assistant's message is coherent but doesn't fulfill the user's request to pull the scheduled departure time — instead it asks booking clarifications and references an arrival (\"I have you arriving 2025-11-16 at 18:34 (local)\") that is unrelated to the asked flight-departure lookup."], "response_clarity": ["The assistant’s clarifying questions are clear and well-structured, but it fails to provide the requested flight departure time in local time and UTC (missing the core information)."]}}, {"trace_id": "cf433ff9-18c0-47f1-9eb4-f79bba1ea809", "iteration": 0, "persona": "expert_user", "success": true, "duration_ms": 274857.5689792633, "scores": {"not_empty": 1.0, "token_budget": 1.0, "keyword_quality": 0.75, "intent_recognition": 0.1, "response_consistency": 0.2, "response_clarity": 0.2}, "final_score": 0.49166666666666675, "pass": false, "reasons": {"keyword_quality": ["missing keywords: help"], "intent_recognition": ["The agent completely missed the user's intent—it asked unrelated booking clarification questions and failed to use the provided PNR, return departure times in local/UTC ISO 8601, or show the API endpoint and required headers."], "response_consistency": ["The assistant's reply is irrelevant to the request—it asks unrelated booking clarification questions and references an arrival into BSL on 2025-11-16 instead of providing the PNR's scheduled departure time in local and UTC ISO 8601 or showing the API endpoint and required headers."], "response_clarity": ["The agent’s text is clear but irrelevant — it only asks unrelated booking clarification questions and fails to provide the scheduled departure time (local and UTC in ISO 8601) or the fastest API endpoint and required headers requested."]}}];
    const criteria = {"performance": {"all_traces_successful": {"met": true, "expected": true, "total_traces": 6, "successful_traces": 6}}, "quality": {"intent_recognition": {"met": false, "average_score": 0.16666666666666669, "threshold": 0.7, "pass_rate": 0.0, "trace_count": 6}, "response_consistency": {"met": false, "average_score": 0.25, "threshold": 0.7, "pass_rate": 0.0, "trace_count": 6}, "response_clarity": {"met": false, "average_score": 0.45, "threshold": 0.7, "pass_rate": 0.3333333333333333, "trace_count": 6}}, "functionality": {}, "overall_success": false};
    const analysis = {"recommendations": [{"title": "Boost overall pass rate", "priority": "high", "summary": "Pass rate is 0.0% (goal 70.0%). Most common failure reason: missing keywords: help.", "metrics": {"pass_rate": 0.0, "threshold": 0.7}}, {"title": "Target persona 'novice_user'", "priority": "medium", "summary": "novice_user pass rate is 0.0% (goal 70.0%). Prioritize playbooks or prompts for this persona.", "metrics": {"persona": "novice_user", "pass_rate": 0.0, "threshold": 0.7}}, {"title": "Target persona 'expert_user'", "priority": "medium", "summary": "expert_user pass rate is 0.0% (goal 70.0%). Prioritize playbooks or prompts for this persona.", "metrics": {"persona": "expert_user", "pass_rate": 0.0, "threshold": 0.7}}]};

    const state = {
      activeTab: "summary",
      personaFilter: "all",
    };

    function setActiveTab(tab) {
      state.activeTab = tab;
      document.querySelectorAll("[data-tab-panel]").forEach((panel) => {
        panel.classList.toggle("hidden", panel.dataset.tabPanel !== tab);
      });
      document.querySelectorAll("[data-tab-button]").forEach((button) => {
        const isActive = button.dataset.tabButton === tab;
        button.classList.toggle("bg-sky-500/20", isActive);
        button.classList.toggle("text-sky-200", isActive);
        button.classList.toggle("border-sky-400", isActive);
        button.classList.toggle("bg-slate-800", !isActive);
        button.classList.toggle("text-slate-300", !isActive);
        button.classList.toggle("border-slate-700", !isActive);
        button.setAttribute("aria-selected", String(isActive));
      });
    }

    function initTabs() {
      document.querySelectorAll("[data-tab-button]").forEach((button) => {
        button.addEventListener("click", () => {
          setActiveTab(button.dataset.tabButton);
        });
      });
      setActiveTab(state.activeTab);
    }

    function formatPercent(value) {
      if (value == null) return "—";
      return `${(value * 100).toFixed(1)}%`;
    }

    function toTitleCase(value) {
      return (value || "")
        .replace(/_/g, " ")
        .replace(/\b\w/g, (c) => c.toUpperCase());
    }

    function renderSummaryCards() {
      const container = document.getElementById("summaryCards");
      if (!container || !summary) return;
      const cards = [
        { label: "Total Traces", value: summary.total_traces ?? "—" },
        { label: "Pass Rate", value: formatPercent(summary.pass_rate) },
        {
          label: "Average Score",
          value: summary.average_score != null ? summary.average_score.toFixed(3) : "—",
        },
        {
          label: "Threshold",
          value: summary.threshold != null ? summary.threshold.toFixed(2) : "—",
        },
      ];
      if (summary.llm_calls != null) {
        cards.push({
          label: "LLM Calls",
          value: `${summary.llm_calls} (sample ${(summary.llm_sample_rate ?? 0).toFixed(2)})`,
        });
      }
      if (summary.overall_success !== undefined) {
        cards.push({
          label: "Overall Success",
          value: summary.overall_success ? "✅ Met" : "❌ Not Met",
        });
      }
      container.innerHTML = cards
            .map(
          (card) => `
            <div class="bg-slate-900 rounded-xl p-4 border border-slate-800 shadow-inner">
              <p class="text-slate-400 text-xs uppercase tracking-wide">${card.label}</p>
              <p class="text-2xl font-semibold mt-2">${card.value}</p>
                </div>
              `
            )
        .join("");
    }

    function renderEvaluationGoal() {
      const container = document.getElementById("evaluationGoal");
      if (!container) return;
      const goal = summary?.evaluation_goal;
      if (!goal) {
        container.textContent = "No evaluation goal provided.";
        container.classList.remove("text-slate-300");
        container.classList.add("text-slate-400");
        return;
      }
      container.classList.remove("text-slate-400");
      container.classList.add("text-slate-300");
      container.textContent = goal;
    }

    function renderCriteria() {
      const container = document.getElementById("criteriaList");
      if (!container || !criteria || !Object.keys(criteria).length) {
        if (container) container.innerHTML = "<p class='text-sm text-slate-400'>No criteria configured.</p>";
        return;
      }
      const overall = criteria.overall_success;
      container.innerHTML = `
        ${
          overall !== undefined
            ? `<p class="text-sm text-slate-300">Overall success: ${
                overall ? "✅ Met" : "❌ Not met"
              }</p>`
            : ""
        }
      `;
      Object.entries(criteria)
        .filter(([key]) => key !== "overall_success")
        .forEach(([section, payload]) => {
          if (!payload) return;
          const checks = Object.entries(payload);
          if (!checks.length) return;
        const sectionTitle = section.replace(/_/g, " ").replace(/\b\w/g, (c) => c.toUpperCase());
          const wrapper = document.createElement("div");
          wrapper.className = "bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-2";
          wrapper.innerHTML = `<h3 class="text-lg font-semibold">${sectionTitle}</h3>`;
        const list = document.createElement("ul");
        list.className = "space-y-1 text-sm text-slate-300";
        for (const [name, details] of checks) {
            const prettyName = toTitleCase(name);
          const status = details.met === true ? "✅ Met" : details.met === false ? "❌ Not met" : "⚪️ Not evaluated";
            const meta = { ...details };
            delete meta.met;
            const extra =
              Object.keys(meta).length > 0 ? `<span class="text-slate-400"> ${JSON.stringify(meta)}</span>` : "";
            list.innerHTML += `<li>${status} · ${prettyName}${extra}</li>`;
        }
          wrapper.appendChild(list);
          container.appendChild(wrapper);
        });
    }

    function renderRecommendations() {
      const container = document.getElementById("recommendations");
      if (!container) return;
      const recommendations = (analysis && analysis.recommendations) || [];
      if (!recommendations.length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>No blocking action items detected.</p>";
        return;
      }
      container.innerHTML = recommendations
        .map(
          (item) => `
            <article class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-2 shadow-inner">
              <div class="flex items-center justify-between gap-2">
                <h3 class="text-lg font-semibold">${item.title}</h3>
                <span class="text-xs px-2 py-1 rounded-full border ${
                  item.priority === "high"
                    ? "border-rose-400 text-rose-300"
                    : item.priority === "medium"
                    ? "border-amber-400 text-amber-300"
                    : "border-slate-500 text-slate-300"
                }">${item.priority?.toUpperCase() || "MEDIUM"}</span>
              </div>
              <p class="text-sm text-slate-300 leading-relaxed">${item.summary || ""}</p>
            </article>
          `
        )
        .join("");
    }

    function renderTopReasons() {
      const container = document.getElementById("topReasons");
      if (!container) return;
      const reasons = summary.top_reasons || [];
      if (!Array.isArray(reasons) || !reasons.length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>No failure reasons recorded.</p>";
        return;
      }
      container.innerHTML = reasons
        .map(
          ([reason, count]) => `
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
              <p class="text-sm text-slate-300">${reason}</p>
              <p class="mt-2 text-2xl font-semibold">${count}</p>
            </div>
          `
        )
        .join("");
    }

    function renderPersonaSummary() {
      const container = document.getElementById("personaSummary");
      if (!container) return;
      const breakdown = summary.persona_breakdown || {};
      const entries = Object.entries(breakdown);
      if (!entries.length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>Persona breakdown is not available.</p>";
        return;
      }
      container.innerHTML = entries
        .map(
          ([persona, stats]) => `
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4 space-y-1">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold">${persona}</h3>
                <span class="text-xs text-slate-400">n=${stats.count ?? 0}</span>
              </div>
              <p class="text-sm text-slate-300">Pass rate: ${formatPercent(stats.pass_rate)}</p>
              <p class="text-sm text-slate-300">Average score: ${
                stats.average_score != null ? stats.average_score.toFixed(3) : "—"
              }</p>
            </div>
          `
        )
        .join("");
    }

    function renderAnalysisContent() {
      const container = document.getElementById("analysisContent");
      if (!container) return;
      if (!analysis || !Object.keys(analysis).length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>No additional analysis computed.</p>";
        return;
      }
      const entries = Object.entries(analysis).filter(([key]) => key !== "recommendations");
      if (!entries.length) {
        container.innerHTML = "<p class='text-sm text-slate-400'>No additional analysis computed.</p>";
        return;
      }
      container.innerHTML = entries
        .map(
          ([key, value]) => `
            <div class="bg-slate-900 border border-slate-800 rounded-xl p-4">
              <h3 class="text-lg font-semibold mb-2">${toTitleCase(key)}</h3>
              <pre class="text-xs whitespace-pre-wrap break-words">${JSON.stringify(value, null, 2)}</pre>
            </div>
          `
        )
        .join("");
    }

    function renderScoreChart() {
      if (typeof Chart === "undefined" || !Array.isArray(perTrace) || !perTrace.length) return;
      const ctx = document.getElementById("scoreChart");
      if (!ctx) return;
      const labels = perTrace.map((item) => item.trace_id ?? item.iteration ?? "");
      const data = perTrace.map((item) => item.final_score ?? 0);
      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Final Score",
              data,
              tension: 0.3,
              fill: false,
              borderColor: "#38bdf8",
              backgroundColor: "#38bdf8",
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: { suggestedMin: 0, suggestedMax: 1 },
          },
        },
      });
    }

    function initTraceFilter() {
      const select = document.getElementById("tracePersonaFilter");
      if (!select) return;
      const personas = Array.from(
        new Set(
          perTrace
            .map((item) => item.persona || "default")
            .filter(Boolean)
        )
      ).sort();
      select.innerHTML = `<option value="all">All personas</option>` + personas.map((p) => `<option value="${p}">${p}</option>`).join("");
      select.value = state.personaFilter;
      select.addEventListener("change", (event) => {
        state.personaFilter = event.target.value;
        renderTraceTable();
      });
      renderTraceTable();
    }

    function renderTraceTable() {
      const table = document.getElementById("traceTable");
      const rawJson = document.getElementById("rawTraceJson");
      if (!table) return;
      const tbody = table.querySelector("tbody");
      const filtered = perTrace.filter((item) => {
        if (state.personaFilter === "all") return true;
        const persona = item.persona || "default";
        return persona === state.personaFilter;
      });
      if (!filtered.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-sm text-slate-400">No traces match the selected filters.</td></tr>`;
      } else {
        tbody.innerHTML = filtered
          .map(
            (item) => `
              <tr class="hover:bg-slate-900/60">
                <td class="px-4 py-3">${item.trace_id ?? "—"}</td>
                <td class="px-4 py-3">${item.persona ?? "—"}</td>
                <td class="px-4 py-3">${item.iteration ?? "—"}</td>
                <td class="px-4 py-3">${item.final_score != null ? item.final_score.toFixed(3) : "—"}</td>
                <td class="px-4 py-3">${item.pass ? "✅" : "❌"}</td>
                <td class="px-4 py-3">
                  ${
                    item.reasons
                      ? Object.entries(item.reasons)
                          .map(([key, value]) => `<span class="block text-xs text-slate-300">${key}: ${Array.isArray(value) ? value.join(", ") : value}</span>`)
                          .join("")
                      : "<span class='text-xs text-slate-500'>—</span>"
                  }
                </td>
              </tr>
            `
          )
          .join("");
      }
      if (rawJson) {
        rawJson.textContent = JSON.stringify(filtered, null, 2);
      }
      const hint = document.getElementById("traceCountHint");
      if (hint) {
        const total = perTrace.length;
        const shown = filtered.length;
        const suffix = total === 1 ? "" : "s";
        hint.textContent = `${shown} of ${total} trace${suffix} shown`;
    }
    }

    initTabs();
    renderSummaryCards();
    renderEvaluationGoal();
    renderCriteria();
    renderRecommendations();
    renderScoreChart();
    renderTopReasons();
    renderPersonaSummary();
    renderAnalysisContent();
    initTraceFilter();
  </script>
</body>
</html>
